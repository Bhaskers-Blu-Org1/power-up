#!/bin/bash
# Copyright 2017 IBM Corp.
#
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -e

GEN_SCRIPTS_PATH=$(dirname $0)
GEN_PATH=${GEN_SCRIPTS_PATH%\/scripts}
GEN_PLAY_PATH=$GEN_PATH/playbooks

source /etc/os-release
. ${GEN_SCRIPTS_PATH}/gen_functions

cname=$(awk -F: '/container_name:/{print $2}' \
${GEN_PLAY_PATH}/host_vars/localhost)
depaddr=$(awk -F= '/ansible_host=/{print $4}' ${GEN_PLAY_PATH}/hosts)
echo 'deployer addr: '$depaddr
ansible_user=$(awk -F= '/ansible_user=/{print $2}' ${GEN_PLAY_PATH}/hosts)
ansible_user=${ansible_user%" "*}
echo 'ansible user: '$ansible_user

if [[ ! "$PATH" = *"cluster-genesis/scripts:"* ]] ||
    [ -z "$complete -p|grep 'gen'" ]; then
    echo "Please source the cluster-genesis/scripts/setup-env script"
    echo "from the cluster-genesis directory"
    echo;
    echo "source scripts/setup-env"
    exit
fi

case "$1" in
    ""|'?')
    echo $'\n'"enter 'gen --help' for usage and a list of available \
        commands"$'\n';;

    '-h'|'--help')
    print_help;;

    'show_mgmt_switches')
    "$GEN_SCRIPTS_PATH"/python/show_mgmt_switches.py "$GEN_PATH"/config.yml \
        DEBUG;;

    'deploy')
    deploy $2;;

    'deploy-passive')
    deploy-passive-1 $2
    deploy-passive-2 $2;;

    'deploy-passive-retry')
    deploy-passive-2 $2;;

    'setup')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts setup.yml;;

    'enable-mgmt-switch')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts enable_mgmt_switch.yml;;

    'lxc-create')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts lxc-create.yml -K;;

    'install_introspection')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts install_introspection.yml;;

    'install_1')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts install_1.yml -K;;

    'install_2')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts install_2.yml -K;;

    'post-deploy')
    post-deploy $2;;

    'ssh_keyscan')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i ./inventory.py ssh_keyscan.yml;;

    'gather_mac_addresses')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i ./inventory.py gather_mac_addresses.yml;;

    'set_data_switch_config')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i hosts container/set_data_switch_config.yml;;

    'configure_operating_systems')
    cd "$GEN_PLAY_PATH"
    ansible-playbook -i ./inventory.py configure_operating_systems.yml;;

    'post-deploy-passive')
    post-deploy-passive $2;;

    'log')
    less +G $GEN_PATH/log.txt;;

    'loga')
    if [ "$2" = "+F" ] || [ "$2" = "-f" ]; then
        less +F $GEN_PLAY_PATH/ansible.log
    else
        less +G $GEN_PLAY_PATH/ansible.log
    fi;;

    'logc')
    show_logc;;

    'config.yml')
    vim $GEN_PATH/config.yml;;

    'inventory')
    if [ -f ~/.ssh/id_rsa_ansible-generated ]; then
        ssh -i ~/.ssh/id_rsa_ansible-generated deployer@$depaddr \
            "cat cluster-genesis/inventory.yml"|less
    else
        echo "No ssh key found"
    fi
    ;;

    'status')
    "$GEN_SCRIPTS_PATH"/python/show_status.py "$GEN_PATH"/config.yml DEBUG;;
esac
