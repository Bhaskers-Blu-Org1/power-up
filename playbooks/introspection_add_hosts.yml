---
# Copyright 2017 IBM Corp.
#
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: introspection_add_hosts.yml (deployer)
  hosts: deployer
  vars:
    syslog_path: '/var/log/syslog'
    pxe_default: '"sent /tftpboot/pxelinux.cfg/default"'
  tasks:
    - name: "Collect introspection host IPs"
      command: "{{ python_executable }} \
                {{ scripts_path }}/python/watch_log.py \
                {{ syslog_path}} \
                {{ pxe_default }} \
                {{ inventory }} \
                {{ log_level }}"
      register: introspection_host_ips
      become: yes
      become_method: sudo

- name: introspection_add_hosts.yml (localhost)
  hosts: localhost
  tasks:
    - name: "Create Ansible \"introspections\" host group"
      lineinfile:
        dest: "{{ project_path_local }}/playbooks/hosts"
        line: "[introspections]"

    - name: "Create Ansible \"introspections\" hosts"
      lineinfile:
        dest: "{{ project_path_local }}/playbooks/hosts"
        insertafter: '^\[introspections\]'
        line: "{{ item }} ansible_user=root \
               ansible_ssh_private_key_file={{ ssh_key_private }}  \
               #introspection"
      with_items:
        - "{{ hostvars['deployer']['introspection_host_ips'].stdout_lines }}"

    - name: "Use ssh-keyscan to collect introspection host keys"
      command: "/usr/bin/ssh-keyscan -H {{ item }}"
      register: ssh_keyscan
      with_items:
        - "{{ hostvars['deployer']['introspection_host_ips'].stdout_lines }}"
      until: ssh_keyscan.stdout != ''
      retries: 6
      delay: 10

    - name: "Append keys to ~/.ssh/known_hosts"
      lineinfile:
        line: "{{ item }}"
        dest: "~/.ssh/known_hosts"
        state: present
        create: "yes"
        mode: 0600
      with_items:
        - "{{ ssh_keyscan.results | sum(attribute='stdout_lines', start=[]) }}"

    - name: "Read Ansible hosts file and register introspection hosts"
      command: "grep introspection {{ project_path_local }}/playbooks/hosts"
      register: introspection_hosts

    - name: "Print introspection hosts table"
      debug:
        msg: "{{ introspection_hosts.stdout.split('\n') }}"

