---
# Copyright 2017 IBM Corp.
#
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: container/ipmi_power_pxe.yml
  hosts: deployer
  vars:
    dhcp_leases_file: "/var/lib/misc/dnsmasq.leases"
  tasks:
    - name: "User Information"
      vars:
        msg: |
            The deployer DHCP service will be polled in order to build a
            table of BMC IP addresses along with working IPMI credentials.
            Credentials provided for each node template is tried on every
            IP address found in the DHCP lease table until a successful set
            is found. This process takes time and is expected to go through
            several iterations before completion. A status table will be
            will be displayed after roughly 5 minutes and upon completion.
      debug:
        msg: "{{ msg.split('\n') }}"

    - name: "Attempt to PXE boot all IPs with current DHCP lease (1)"
      command: "{{ python_executable }} \
                {{ scripts_path }}/python/ipmi_power_pxe.py \
                {{ inventory }} \
                {{ dhcp_leases_file }} \
                {{ power_time_out_sec }} \
                {{ power_wait_sec }} \
                {{ log_level }}"
      register: result
      until: result.stdout.find("FAIL") == -1
      retries: 10
      delay: 30
      failed_when: result.rc != 0

    - name: "Print BMC IPMI Table (1)"
      debug:
        msg: "{{ result.stdout.split('\n') }}"

    - block:
        - name: "Attempt to PXE boot all IPs with current DHCP lease (2)"
          command: "{{ python_executable }} \
                    {{ scripts_path }}/python/ipmi_power_pxe.py \
                    {{ inventory }} \
                    {{ dhcp_leases_file }} \
                    {{ power_time_out_sec }} \
                    {{ power_wait_sec }} \
                    {{ log_level }}"
          register: result2
          until: result2.stdout.find("FAIL") == -1
          retries: 50
          delay: 30

      when: result.stdout.find("FAIL") != -1
      always:
        - name: "Print BMC IPMI Table (2/3)"
          debug:
            msg: "{{ result2.stdout.split('\n') }}"

      rescue:
        - name: "Print BMC IPMI Table (2)"
          debug:
            msg: "{{ result2.stdout.split('\n') }}"

        - name: "Wait for user"
          pause:
            prompt: |
                Incomplete table, please check credentials & connections
                Press <enter> to continue

        - name: "Attempt to PXE boot all IPs with current DHCP lease (3)"
          command: "{{ python_executable }} \
                    {{ scripts_path }}/python/ipmi_power_pxe.py \
                    {{ inventory }} \
                    {{ dhcp_leases_file }} \
                    {{ power_time_out_sec }} \
                    {{ power_wait_sec }} \
                    {{ log_level }}"
          register: result2
          until: result2.stdout.find("FAIL") == -1
          retries: 60
          delay: 30
