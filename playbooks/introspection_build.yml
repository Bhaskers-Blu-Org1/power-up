---
# Copyright 2017 IBM Corp.
#
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: introspection_build.yml
  hosts: deployer
  vars:
    project_path_local: "{{ hostvars['localhost']['project_path_local'] }}"
    images_local: "{{ hostvars['localhost']['project_path_local'] }}/os_images"
    intro_local: "{{ hostvars['localhost']['project_path_local'] }}/introspection"
    config_buildroot: "{{ lookup('env', 'IS_BUILDROOT_CONFIG') }}"
    config_kernel: "{{ lookup('env', 'IS_KERNEL_CONFIG') }}"

  tasks:
    - name: "Check if introspection kernel exists"
      local_action: stat path="{{ project_path_local }}/os_images/introspection/vmlinux"
      register: stat_result_kernel

    - name: "Check if introspection initrd exists"
      local_action: stat path="{{ project_path_local }}/os_images/introspection/rootfs.cpio.gz"
      register: stat_result_initrd

    - name: "Skip build: Use existing kernel and initrd"
      meta: end_play
      when:
        - stat_result_kernel.stat.exists
        - stat_result_initrd.stat.exists

    - name: "Create introspection directory"
      file:
        path: "{{ project_path }}/introspection"
        state: directory

    - name: "Copy introspection directory"
      copy:
        src: "{{ intro_local }}"
        dest: "{{ project_path }}"

    - name: "Change introspection script permissions"
      file:
        path: "{{ project_path }}/introspection/{{ item }}"
        mode: "u=rwx,g=rwx,o=rwx"
      with_items:
        - 'build.sh'
        - 'add_key.sh'
        - 'patch_source.sh'
        - 'setup.sh'
        - 'overlayfs/etc/init.d/S60dhcpcd'

    - name: "RHEL/CentOS: Fix selinuxfs being mounted read-write in the chroot"
      mount:
        name: /sys/fs/selinux
        state: mounted
        src: selinuxfs
        fstype: selinuxfs
        opts: remount,ro
      when: hostvars['localhost']['ansible_distribution'] in ['RedHat','CentOS']
      become: yes
      become_method: sudo

    - name: "Update apt cache and upgrade (safe)"
      apt:
        update_cache: yes
      become: yes
      become_method: sudo

    - name: "Install buildroot  packages"
      apt:
        name: "{{ item }}"
      with_items:
        - make
        - gcc
        - g++
        - wget
        - unzip
        - patch
        - rsync
        - git
        - bzip2
        - cpio
        - bc
      become: yes
      become_method: sudo

    - name: "Copy deployer authorized_keys into introspection"
      copy:
        src: "{{ ansible_env.HOME}}/.ssh/authorized_keys"
        dest: "{{ project_path }}/introspection/overlayfs/root/.ssh/authorized_keys"
        remote_src: yes

    - name: "Execute introspection 'setup.sh' script"
      command: "./setup.sh"
      args:
        chdir: "{{ project_path }}/introspection/"

    - name: "Execute introspection 'build.sh' script"
      command: "./build.sh"
      args:
        chdir: "{{ project_path }}/introspection/"

    - name: "Copy kernel and ramdisk into 'os_images/introspection'"
      fetch:
        src: "{{ project_path }}/introspection/output/images/{{ item }}"
        dest: "{{ images_local }}/introspection/"
        flat: yes
      with_items:
        - rootfs.cpio.gz
        - vmlinux
